---
import Layout from '../layouts/Layout.astro';
import type { GetAuthReturn } from '@clerk/astro/server'

const { getToken } = Astro.locals.auth() as unknown as GetAuthReturn;

let bookmarks = [];
let error = '';

const token = await getToken();

if (!token) {
  error = 'User not authenticated';
} else {
  try {
    const response = await fetch('http://localhost:4200/api/links', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      const resp = await response.json();

      bookmarks = resp.data;
    } else {
      error = 'Failed to fetch bookmarks';
    }
  } catch (e) {
    error = 'Unable to connect to API server';
  }
}
---

<Layout title="Dashboard - Bookmark Manager">
  <div>
    <h1>Your Bookmarks</h1>
    <a href="/bookmarks/new" >Add New Bookmark</a>
  </div>

  {error && (
    <div >
      {error}
    </div>
  )}

  {bookmarks.length === 0 && !error ? (
    <div >
      <h3>No bookmarks yet</h3>
      <p>
        Start by adding your first bookmark!
      </p>
      <a href="/bookmarks/new" >Add Bookmark</a>
    </div>
  ) : (
    <div >
      {bookmarks.map((bookmark: any) => (
        <div >
          <div >
            <h3>{bookmark.title}</h3>
            <p>{bookmark.description}</p>
            <a href={bookmark.url} target="_blank" rel="noopener noreferrer">
              {bookmark.url}
            </a>
          </div>
          <div >
            <a href={`/bookmarks/edit/${bookmark.id}`} >Edit</a>
            <form method="POST" action="/api/bookmarks/delete">
              <input type="hidden" name="id" value={bookmark.id} />
              <button type="submit" 
                      onclick="return confirm('Are you sure you want to delete this bookmark?')">
                Delete
              </button>
            </form>
          </div>
        </div>
      ))}
    </div>
  )}
</Layout>
