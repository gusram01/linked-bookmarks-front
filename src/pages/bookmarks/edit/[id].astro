---
import Layout from '../../../layouts/Layout.astro';

const auth = Astro.locals.auth();

let bookmark = null;
let error = '';
let success = '';

// Fetch existing bookmark
try {
  const response = await fetch(`http://localhost:8080/api/bookmarks/${Astro.params.id}`, {
    headers: {
      'Authorization': `Bearer ${auth.userId}`,
      'Content-Type': 'application/json'
    }
  });
  
  if (response.ok) {
    bookmark = await response.json();
  } else {
    error = 'Bookmark not found';
  }
} catch (e) {
  error = 'Unable to connect to API server';
}

if (Astro.request.method === 'POST' && bookmark) {
  try {
    const formData = await Astro.request.formData();
    const title = formData.get('title');
    const url = formData.get('url');
    const description = formData.get('description');

    const response = await fetch(`http://localhost:8080/api/bookmarks/${Astro.params.id}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${auth.userId}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        title,
        url,
        description
      })
    });

    if (response.ok) {
      Astro.redirect('/dashboard?success=Bookmark updated successfully');
    } else {
      error = 'Failed to update bookmark';
    }
  } catch (e) {
    error = 'Unable to connect to API server';
  }
}

if (!auth.userId) {
  Astro.redirect('/api/auth/signin');
}
---

<Layout title="Edit Bookmark - Bookmark Manager">
  <div >
    <h1>Edit Bookmark</h1>
    
    {error && (
      <div >
        {error}
      </div>
    )}

    {bookmark ? (
      <div >
        <form method="POST">
          <div>
            <label for="title">Title</label>
            <input type="text" id="title" name="title" value={bookmark.title} required />
          </div>

          <div >
            <label for="url">URL</label>
            <input type="url" id="url" name="url" value={bookmark.url} required />
          </div>

          <div >
            <label for="description">Description</label>
            <textarea id="description" name="description" rows="3">{bookmark.description}</textarea>
          </div>

          <div >
            <button type="submit" >Update Bookmark</button>
            <a href="/dashboard" >Cancel</a>
          </div>
        </form>
      </div>
    ) : (
      <div>
        <h3>Bookmark not found</h3>
        <a href="/dashboard" >Back to Dashboard</a>
      </div>
    )}
  </div>
</Layout>
